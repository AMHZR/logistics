{% extends base_template %}

{% load maps_tags %}

{% block javascripts %}{{ block.super }}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript">
    $(function() {
        var last_marker = null;
        
	    var latlng = new google.maps.LatLng({{ default_latitude }}, {{ default_longitude }});
	    var myOptions = {
	      zoom: 8,
	      center: latlng,
	      mapTypeId: google.maps.MapTypeId.ROADMAP
	    };
	    var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
        
        var bounds = new google.maps.LatLngBounds();
        
{% for sp in supply_points %}
        {% comment %}
        ##########################################################
        this counter0 stuff is a horrible hack to make sure we have 
        unique variable names. the right answer is to probably do 
        this in a javascript loop, but that means jsonifying the data
        ##########################################################
        {% endcomment %}
        var latlng{{forloop.counter0}} = new google.maps.LatLng({{ sp.location.point.latitude }}, {{ sp.location.point.longitude }});
        
        var marker{{forloop.counter0}} = new google.maps.Marker({
            position: latlng{{forloop.counter0}}, 
            map: map, 
            title:"{{ sp.name }}",
            icon: "{% get_map_icon sp request %}"
        });
        marker{{forloop.counter0}}.infowindow = new google.maps.InfoWindow({content: '{% get_map_popup sp request %}'});
        google.maps.event.addListener(marker{{forloop.counter0}}, 'click', function(event) {
            if (last_marker != null) { last_marker.infowindow.close(); }
            marker{{forloop.counter0}}.infowindow.open(map, marker{{forloop.counter0}});
            last_marker = marker{{forloop.counter0}};
        });
        
        bounds.extend(latlng{{forloop.counter0}});
{% endfor %}

        //map.fitBounds(bounds);
    });
</script>
{% endblock %}

{% block stylesheets %}{{ block.super }}
<style type="text/css">
	  #map_canvas { width: 100%; height: 50em;}
</style>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
{% endblock %}

{% block content %}
    <h2>Map</h2>
    <div id="map_canvas"></div>
{% endblock %}